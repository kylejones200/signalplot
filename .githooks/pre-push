#!/bin/bash
# Pre-push hook to test the package before pushing

set -e  # Exit on any error

echo "Running pre-push tests..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in the right directory
if [ ! -f "pyproject.toml" ]; then
    echo -e "${RED}Error: pyproject.toml not found. Are you in the project root?${NC}"
    exit 1
fi

# Step 1: Build the package
echo -e "${YELLOW}Step 1: Building package...${NC}"
python -m pip install --upgrade pip build --quiet > /dev/null 2>&1
python -m build > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo -e "${RED}✗ Package build failed${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Package built successfully${NC}"

# Step 2: Test imports from source
echo -e "${YELLOW}Step 2: Testing imports...${NC}"
python -c "
import sys
sys.path.insert(0, '.')
import signalplot as sp
assert hasattr(sp, 'apply')
assert hasattr(sp, 'figure')
assert hasattr(sp, 'save')
assert hasattr(sp, '__version__')
print('✓ All imports successful')
"
if [ $? -ne 0 ]; then
    echo -e "${RED}✗ Import test failed${NC}"
    exit 1
fi
echo -e "${GREEN}✓ Imports successful${NC}"

# Step 3: Run a basic smoke test
echo -e "${YELLOW}Step 3: Running smoke test...${NC}"
python -c "
import sys
sys.path.insert(0, '.')
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import signalplot as sp
import matplotlib.pyplot as plt

# Apply signalplot style
sp.apply()

# Create a simple plot (using basic Python, no numpy required)
x = [i * 0.1 for i in range(100)]
y = [i * 0.1 for i in range(100)]  # Simple linear plot
ax = plt.subplot()
ax.plot(x, y, color='black', linewidth=1.5)
ax.set_title('Test Plot')

# Test save functionality
sp.save('test_output.png')
plt.close('all')
print('✓ Smoke test passed')
"
if [ $? -ne 0 ]; then
    echo -e "${RED}✗ Smoke test failed${NC}"
    exit 1
fi

# Clean up test file
rm -f test_output.png

echo -e "${GREEN}✓ All pre-push tests passed!${NC}"
exit 0
